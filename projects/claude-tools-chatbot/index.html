<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../claude-multimodal-llm-playground/bedrock/ rel=prev><link href=../complex-schema-tool-use/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.5"><title>Claude Tools Chatbot - Anthropic on AWS</title><link rel=stylesheet href=../../assets/stylesheets/main.8608ea7d.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Segoe+UI:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Segoe UI";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Claude Tools Chatbot - Anthropic on AWS"><meta property=og:description content=None><meta property=og:image content=./assets/images/social/projects/claude-tools-chatbot.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta property=og:url content=None><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Claude Tools Chatbot - Anthropic on AWS"><meta name=twitter:description content=None><meta name=twitter:image content=./assets/images/social/projects/claude-tools-chatbot.png><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#claude-tools-chatbot class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Anthropic on AWS" class="md-header__button md-logo" aria-label="Anthropic on AWS" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Anthropic on AWS </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Claude Tools Chatbot </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Anthropic on AWS" class="md-nav__button md-logo" aria-label="Anthropic on AWS" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Anthropic on AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../cookbooks/ class=md-nav__link> <span class=md-ellipsis> Cookbooks </span> </a> </li> <li class=md-nav__item> <a href=../../workshops/ class=md-nav__link> <span class=md-ellipsis> Workshops </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Demos </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../classification-with-intercom/ class=md-nav__link> <span class=md-ellipsis> Classification with Intercom </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <div class="md-nav__link md-nav__container"> <a href=../claude-multimodal-llm-playground/ class="md-nav__link "> <span class=md-ellipsis> Claude Multimodal LLM Playground </span> </a> <label class="md-nav__link " for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Claude Multimodal LLM Playground </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../claude-multimodal-llm-playground/anthropic/ class=md-nav__link> <span class=md-ellipsis> Anthropic </span> </a> </li> <li class=md-nav__item> <a href=../claude-multimodal-llm-playground/bedrock/ class=md-nav__link> <span class=md-ellipsis> Bedrock </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Claude Tools Chatbot </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <div class="md-nav__link md-nav__container"> <a href=../complex-schema-tool-use/ class="md-nav__link "> <span class=md-ellipsis> Complex Schema Tool Use </span> </a> <label class="md-nav__link " for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Complex Schema Tool Use </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../complex-schema-tool-use/nextjs-typescript-example/ class=md-nav__link> <span class=md-ellipsis> NextJS Typescript Example </span> </a> </li> <li class=md-nav__item> <a href=../complex-schema-tool-use/streamlit-python-example/ class=md-nav__link> <span class=md-ellipsis> Streamlit Python Example </span> </a> </li> <li class=md-nav__item> <a href=../complex-schema-tool-use/streamlit-stepfunction-example/ class=md-nav__link> <span class=md-ellipsis> Streamlit Stepfunction Example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../metaprompt-generator/ class=md-nav__link> <span class=md-ellipsis> Metaprompt Generator </span> </a> </li> <li class=md-nav__item> <a href=../pdf-knowledge-base-with-citations.md class=md-nav__link> <span class=md-ellipsis> PDF Knowledge Base with Citations </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=claude-tools-chatbot>Claude Tools Chatbot</h1> <h1 id=creating-a-chatbot-with-claude-tool-use-and-amazon-bedrock-converse-api>Creating a ChatBot with Claude Tool use and Amazon Bedrock Converse API</h1> <p>This example will demonstrate how to build a simple ChatBot application using <a href=https://docs.anthropic.com/en/docs/tool-use>Claude Tools</a> and the <a href=https://aws.amazon.com/bedrock/ >Amazon Bedrock</a> <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/conversation-inference.html>Converse API</a>.</p> <p><a class=glightbox href=images/ClaudeToolsChatBotOverview.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=Overview src=images/ClaudeToolsChatBotOverview.png></a></p> <p>This demo will deploy a simple client that will interact with an <a href=https://aws.amazon.com/appsync/ >AWS AppSync</a> GraphQL API. This API will use an <a href=https://docs.aws.amazon.com/appsync/latest/devguide/tutorial-lambda-resolvers.html>AWS Lambda resolver</a> to make requests to Amazon Bedrock with the <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/conversation-inference.html>Amazon Bedrock Converse API</a>. These requests and responses are stored in an <a href=https://aws.amazon.com/dynamodb/ >Amazon DynamoDB</a> table via the AppSync API that allows for easy updates in the client. With these tools, we can create a chat bot that is able to look up orders in a database by using the <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/tool-use.html>tool use</a> feature of Amazon Bedrock.</p> <ul> <li><a href=#creating-a-chatbot-with-claude-tool-use-and-amazon-bedrock-converse-api>Creating a ChatBot with Claude Tool use and Amazon Bedrock Converse API</a></li> <li><a href=#infrastructure>Infrastructure</a><ul> <li><a href=#appsync>AppSync</a></li> <li><a href=#vpc>VPC</a></li> <li><a href=#rds>RDS</a></li> <li><a href=#lambda-resolver>Lambda Resolver</a></li> </ul> </li> <li><a href=#chat-bot-interactions>Chat Bot Interactions</a><ul> <li><a href=#bedrock-converse-client-configuration>Bedrock Converse Client Configuration</a></li> <li><a href=#basic-configuration>Basic configuration</a></li> <li><a href=#tool-config>Tool Config</a></li> <li><a href=#system-prompt>System Prompt</a></li> <li><a href=#messages>Messages</a></li> <li><a href=#basic-flow>Basic Flow</a></li> <li><a href=#tools-required>Tools Required</a></li> <li><a href=#using-the-tool>Using the tool</a></li> <li><a href=#continued-conversation>Continued conversation</a></li> </ul> </li> <li><a href=#using-the-demo>Using the Demo</a><ul> <li><a href=#deploying>Deploying</a></li> <li><a href=#logging-in>Logging In</a></li> <li><a href=#example-conversations>Example Conversations</a></li> <li><a href=#order-lookup>Order Lookup</a></li> <li><a href=#cancel-order>Cancel Order</a></li> <li><a href=#account-lookup>Account Lookup</a></li> <li><a href=#combining-requests>Combining Requests</a></li> <li><a href=#cleanup>Cleanup</a></li> </ul> </li> </ul> <h2 id=infrastructure>Infrastructure</h2> <p>The infrastructure in this demo is deployed using <a href=https://aws.amazon.com/cdk/ >AWS Cloud Development Kit</a> (CDK) and creates all of the necessary components for you.</p> <h3 id=appsync>AppSync</h3> <pre><code class=language-typescript>this.graphqlApi = new GraphqlApi(this, 'graphqlApi', {
  name: 'ClaudeTools',
  definition: {
    schema: SchemaFile.fromAsset('./src/resources/graphql/schema.graphql'),
  },
  logConfig: {
    retention: RetentionDays.ONE_WEEK,
    fieldLogLevel: FieldLogLevel.ALL,
  },
  authorizationConfig: {
    defaultAuthorization: {
      authorizationType: AuthorizationType.USER_POOL,
      userPoolConfig: {
        userPool: props.userPool,
      },
    },
    additionalAuthorizationModes: [
      {
        authorizationType: AuthorizationType.API_KEY,
        apiKeyConfig: {
          expires: Expiration.after(Duration.days(365)),
        },
      },
    ],
  },
  xrayEnabled: true,
});
</code></pre> <p>To create the AppSync API, we will use the defined <a href=src/resources/graphql/schema.graphql>schema</a>. <a href=https://docs.aws.amazon.com/appsync/latest/devguide/schema-components.html>The schema</a> is the foundation of the GraphQL API and serves as a blueprint for the data will be using.</p> <p>Next we will define two data sources for our API:</p> <pre><code class=language-typescript>const messageProcessorDataSource = this.graphqlApi.addLambdaDataSource(
  'MessageProcessorDataSource',
  props.messageProcessorLambda,
);

const conversationDataSource = this.graphqlApi.addDynamoDbDataSource(
  'ConversationDataSource',
  props.conversationTable,
);
</code></pre> <p>The <code>messageProcessorLambda</code> will be where all of the interactions with Bedrock occur. When a user interacts with the client, the messages they type will be sent to this Lambda function. The <code>conversationTable</code> is where the chat messages are stored. This is also used to pass the information back to the client through an <a href=https://docs.aws.amazon.com/appsync/latest/devguide/aws-appsync-real-time-data.html>AppSync subscription</a>. When a mutation occurs, the subscription will be triggered and the client updated with the new data.</p> <p>We control this by adding resolvers to the data sources:</p> <pre><code class=language-typescript>messageProcessorDataSource.createResolver('ProcessMessage', {
  typeName: 'Mutation',
  fieldName: 'processMessage',
  requestMappingTemplate: MappingTemplate.fromFile(
    './src/resources/graphql/Mutation.ProcessMessage.req.vtl',
  ),
  responseMappingTemplate: MappingTemplate.fromFile(
    './src/resources/graphql/Mutation.ProcessMessage.res.vtl',
  ),
});

conversationDataSource.createResolver('UpdateConversation', {
  typeName: 'Mutation',
  fieldName: 'updateConversation',
  requestMappingTemplate: MappingTemplate.fromFile(
    './src/resources/graphql/Mutation.UpdateConversation.req.vtl',
  ),
  responseMappingTemplate: MappingTemplate.fromFile(
    './src/resources/graphql/Mutation.UpdateConversation.res.vtl',
  ),
});
</code></pre> <p>Now, when the <code>processMessage</code> API is invoked it will use the <code>messageProcessorDataSource</code> and when the <code>updateConversation</code> API is invoked it will use the <code>conversationDataSource</code>.</p> <h3 id=vpc>VPC</h3> <p>This demo uses an <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/usingVPC.html>AWS PrivateLink</a> to access Bedrock. Later we will deploy other services to this <a href=https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html>Amazon Virtual Private Cloud</a> (Amazon VPC).</p> <pre><code class=language-typescript>this.vpc = new Vpc(this, 'VPC', {
  natGateways: 1,
  subnetConfiguration: [
    {
      cidrMask: 24,
      name: 'PrivateWithEgress',
      subnetType: SubnetType.PRIVATE_WITH_EGRESS,
    },
    {
      cidrMask: 24,
      name: 'Public',
      subnetType: SubnetType.PUBLIC,
    },
  ],
});

this.securityGroup = new SecurityGroup(this, 'SecurityGroup', {
  vpc: this.vpc,
  description: 'Security Group',
  allowAllOutbound: true,
});

this.bedrockInterfaceEndpoint = this.vpc.addInterfaceEndpoint(
  'BedrockAccessPoint',
  {
    service: InterfaceVpcEndpointAwsService.BEDROCK_RUNTIME,
    privateDnsEnabled: true,
  },
);

this.bedrockInterfaceEndpoint.addToPolicy(
  new PolicyStatement({
    principals: [new AnyPrincipal()],
    actions: ['bedrock:InvokeModel'],
    resources: ['arn:aws:bedrock:*::foundation-model/*'],
  }),
);
</code></pre> <p>This VPC creates two <a href=https://docs.aws.amazon.com/vpc/latest/userguide/configure-subnets.html>Subnets</a> - a Public and Private with Egress subnet. This will also create a <a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html>NAT Gateway</a> in this VPC. Most importantly though, it create an <a href=https://docs.aws.amazon.com/vpc/latest/privatelink/create-interface-endpoint.html>interface VPC endpoint</a> that will allow access to Bedrock within the VPC. Now, when a resource within the VPC makes a request to Bedrock, it will do so over a private connection.</p> <h3 id=rds>RDS</h3> <p>This demo includes a database that we will use as one of our tools. This database will store customer and order information that will be retrieved by our Lambda resolver function. We will put this database in the same private subnet in our VPC with our Lambda function so all of the communication occurs over our private connection.</p> <pre><code class=language-typescript>this.database = new DatabaseInstance(this, 'database', {
  engine: DatabaseInstanceEngine.POSTGRES,
  vpc: props.vpc,
  vpcSubnets: { subnetType: SubnetType.PRIVATE_WITH_EGRESS },
  instanceType: InstanceType.of(
    InstanceClass.BURSTABLE4_GRAVITON,
    InstanceSize.MEDIUM,
  ),
  multiAz: false,
  allowMajorVersionUpgrade: true,
  autoMinorVersionUpgrade: true,
  backupRetention: Duration.days(0),
  securityGroups: [props.securityGroup],
});

this.database.connections.allowInternally;
</code></pre> <p>This database will be built with <a href=https://aws.amazon.com/rds/ >Amazon Relational Database Service</a> (RDS) and use <a href=https://aws.amazon.com/rds/postgresql/ >PostgreSQL</a> as the database system. During deployment of the CDK, we will also <a href=src/resources/initializerLambda/index.py>initialize</a> the database with our fake customer and order data using a <a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html>Custom Resource</a>.</p> <pre><code class=language-python>def on_create(event):
    try:
        create_tables()
        load_data()
        physical_id = &quot;CreateTablesAndLoadData&quot;
        return {&quot;PhysicalResourceId&quot;: physical_id}
    except Exception as e:
        print(f&quot;Error in on_create: {e}&quot;)
        raise e
</code></pre> <p>With the database created and initialized, we will have access to it from our other resources.</p> <h3 id=lambda-resolver>Lambda Resolver</h3> <p>As noted above, our Lambda resolver will be used to interact with Bedrock and our database. All of these resources are created in a private subnet of our VPC and will need access to those resources through the private connection.</p> <p>To ensure that the Lambda uses this private connection when making requests to Bedrock, we will assign it an <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html>IAM Role</a> with a conditional <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html>IAM Policy</a> that allows <code>InvokeModel</code> only through the specific VPC interface endpoint.</p> <pre><code class=language-typescript>const resolverLambdaRole = new Role(this, 'resolverLambdaRole', {
  assumedBy: new ServicePrincipal('lambda.amazonaws.com'),
  inlinePolicies: {
    ['bedrock']: new PolicyDocument({
      statements: [
        new PolicyStatement({
          resources: ['*'],
          actions: ['bedrock:InvokeModel'],
          conditions: {
            'ForAnyValue:StringEquals': {
              'aws:sourceVpce': [props.bedrockInterfaceEndpoint.vpcEndpointId],
            },
          },
        }),
      ],
    }),
  },
});
</code></pre> <p>Because the <a href=https://pypi.org/project/boto3/ >boto3</a> version in our Lambda uses the <code>Converse</code> API feature and the current default Lambda runtime might not include this, we need to build our Lambda function using <a href=https://www.docker.com/ >Docker</a> before deploying it with our CDK. This requires running <a href=https://docs.docker.com/config/daemon/start/ >Docker daemon</a> on the device deploying the CDK, but ensures that the Lambda has all of the necessary and up to date packages for using the latest features.</p> <pre><code class=language-typescript>this.resolverLambda = new Function(this, 'resolverLambda', {
  code: Code.fromAsset(path.join(__dirname, 'resources/resolverLambda'), {
    bundling: {
      image: Runtime.PYTHON_3_12.bundlingImage,
      command: [
        'bash',
        '-c',
        'pip install -r requirements.txt -t /asset-output &amp;&amp; cp -au . /asset-output',
      ],
    },
  }),
  runtime: Runtime.PYTHON_3_12,
  vpc: props.vpc,
  vpcSubnets: { subnetType: SubnetType.PRIVATE_WITH_EGRESS },
  architecture: Architecture.ARM_64,
  handler: 'index.handler',
  timeout: Duration.minutes(5),
  role: resolverLambdaRole,
  environment: {
    RDS_SECRET_NAME: props.database.secret?.secretName!,
  },
});
</code></pre> <p>Now, when we deploy our CDK, we will install the dependencies in our <code>requirements.txt</code> file before bundling and zipping the Lambda function.</p> <h2 id=chat-bot-interactions>Chat Bot Interactions</h2> <h3 id=bedrock-converse-client-configuration>Bedrock Converse Client Configuration</h3> <p>With our infrastructure deployed, we're ready to interact with our chat bot. To do this, we will make a request from our client. Every request we make will follow the same basic pattern and use the same request.</p> <pre><code class=language-python>    response = bedrock_client.converse(
        modelId=model_id,
        messages=converted_messages,
        system=system_prompts,
        toolConfig=tool_config,
        inferenceConfig=inference_config,
        additionalModelRequestFields=additional_model_fields,
    )
</code></pre> <p>Each time we make this request, we will provide Claude the information it needs to process the request.</p> <h4 id=basic-configuration>Basic configuration</h4> <pre><code class=language-python>temperature = 0
top_k = 10
max_tokens = 4096
inference_config = {&quot;temperature&quot;: temperature, &quot;maxTokens&quot;: max_tokens}
additional_model_fields = {&quot;top_k&quot;: top_k}
</code></pre> <p>Each of these are statically defined for every request.</p> <h4 id=tool-config>Tool Config</h4> <p>Next we will tell Claude what tools it has access to with <a href=src/resources/resolverLambda/tools.py><code>toolConfig</code></a>:</p> <pre><code class=language-python>tool_config = {
    &quot;toolChoice&quot;: {&quot;auto&quot;: {}},
    &quot;tools&quot;: [
        {
            &quot;toolSpec&quot;: {
                &quot;name&quot;: &quot;get_user&quot;,
                &quot;description&quot;: &quot;Looks up a user by email, phone, or username.&quot;,
                ...
            },
        },
        {
            &quot;toolSpec&quot;: {
                &quot;name&quot;: &quot;get_order_by_id&quot;,
                &quot;description&quot;: &quot;Retrieves the details of a specific order based on the order ID. Returns the order ID, product name, quantity, price, and order status.&quot;,
                ...
            },
        },
        {
            &quot;toolSpec&quot;: {
                &quot;name&quot;: &quot;get_customer_orders&quot;,
                &quot;description&quot;: &quot;Retrieves the list of orders belonging to a user based on a user's customer id.&quot;,
                ...
            },
        },
        {
            &quot;toolSpec&quot;: {
                &quot;name&quot;: &quot;cancel_order&quot;,
                &quot;description&quot;: &quot;Cancels an order based on a provided order_id.  Only orders that are 'processing' can be cancelled&quot;,
                ...
            },
        },
    ],
}
</code></pre> <p>Each of these tools has a defined schema and description that tells Claude what it can do and what is required to use. For example:</p> <pre><code class=language-python>{
    &quot;toolSpec&quot;: {
        &quot;name&quot;: &quot;get_order_by_id&quot;,
        &quot;description&quot;: &quot;Retrieves the details of a specific order based on the order ID. Returns the order ID, product name, quantity, price, and order status.&quot;,
        &quot;inputSchema&quot;: {
            &quot;json&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;properties&quot;: {
                    &quot;order_id&quot;: {
                        &quot;type&quot;: &quot;string&quot;,
                        &quot;description&quot;: &quot;The unique identifier for the order.&quot;,
                    }
                },
                &quot;required&quot;: [&quot;order_id&quot;],
            },
        },
    },
}
</code></pre> <p>This tells Claude that it has access to a function that can look up an order if it knows what the <code>order_id</code> is. This also defines the <code>inputSchema</code> so that Claude knows what the properties the tool uses and what is required. We'll see how to use this later.</p> <h4 id=system-prompt>System Prompt</h4> <p>Next, wee will define a system prompt that lets Claude know that tools are available to use if needed, but aren't necessary.</p> <pre><code class=language-python>system_prompt = &quot;&quot;&quot;
You are a customer support chat bot for an online retailer called AnyCompany.
Your job is to help users look up their account, orders, and cancel orders.
Be helpful and brief in your responses.
You have access to a set of tools, but only use them when needed.
If you do not have enough information to use a tool correctly, ask a user follow up questions to get the required inputs.
Do not call any of the tools unless you have the required data from a user.

In each conversational turn, you will begin by thinking about your response.
Use &lt;thinking&gt;&lt;/thinking&gt; to think through the process step by step ensuring that you have all of the required input.
Once you're done, you will write a user-facing response.
It's important to place all user-facing conversational responses in &lt;reply&gt;&lt;/reply&gt; XML tags to make them easy to parse.
&quot;&quot;&quot;
</code></pre> <h4 id=messages>Messages</h4> <p>Finally, we will define the <code>messages</code> as the entire turn by turn history of the conversation. This will change each time we make a request by appending the latest request with all of the previous requests so that Claude has the entire context of the conversation.</p> <h3 id=basic-flow>Basic Flow</h3> <p>In a basic flow where tool use is not required:</p> <ul> <li>The user sends a request to the Lambda resolver through the AppSync API</li> <li>The Lambda resolver queries the conversation Table for the <code>conversationId</code></li> <li>The Lambda resolver appends to (for an existing conversation) or creates (for a new conversation) an item in the conversation Table</li> <li>This mutation triggers the AppSync subscription to update the client</li> <li>The Lambda resolver makes a request to Bedrock using the Converse API with the entire conversation</li> <li>Bedrock responds</li> <li>The Lambda resolver appends the existing item in the conversation Table with the response</li> <li>This mutation triggers the AppSync subscription to update the client</li> </ul> <p><a class=glightbox href=images/BasicFlow.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=BasicFlow src=images/BasicFlow.png></a></p> <p>For example:</p> <pre><code class=language-text>User: I need help with an order
</code></pre> <p>This message is passed to Bedrock along with the system prompt. The response from Bedrock will look something like this:</p> <pre><code class=language-json>{
  &quot;output&quot;: {
    &quot;message&quot;: {
      &quot;role&quot;: &quot;assistant&quot;,
      &quot;content&quot;: [
        {
          &quot;text&quot;: &quot;Okay, let's see how I can assist you with your order. &lt;thinking&gt;\nTo look up details about an order, I will need the order ID. I should ask the user for that first.\n&lt;/thinking&gt;\n\n&lt;reply&gt;\nSure, I'd be happy to help you with your order. Can you please provide me with the order ID? This will allow me to look up the specific details of your order.\n&lt;/reply&gt;&quot;
        }
      ]
    }
  },
  &quot;stopReason&quot;: &quot;end_turn&quot;
}
</code></pre> <p>We can see that Claude used <code>&lt;thinking&gt;</code> to determine that it needs additional information to help the user. However, the <code>stopReason</code> is still <code>end_turn</code> because Claude has been instructed to only use tools when all of the information required is available. In this case, it still needs an order ID.</p> <pre><code class=language-text>Bot:  Sure, I'd be happy to help you with your order. Can you please provide me with the order ID? This will allow me to look up the specific details of your order.
</code></pre> <p><a class=glightbox href=images/BasicChat.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=BasicChat src=images/BasicChat.png></a></p> <h3 id=tools-required>Tools Required</h3> <p>At this point in the flow, Claude has prompted the user to provide an Order ID because it needs that information in order to retrieve the order details.</p> <pre><code class=language-text>User: my order is 14826
</code></pre> <p>As we continue to append the conversation with each turn, we now send this to Bedrock:</p> <pre><code class=language-json>[
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;i need help with an order&quot;
      }
    ],
    &quot;role&quot;: &quot;user&quot;
  },
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;Okay, let's see how I can assist you with your order. &lt;thinking&gt;\nTo look up details about an order, I will need the order ID. I should ask the user for that first.\n&lt;/thinking&gt;\n\n&lt;reply&gt;\nSure, I'd be happy to help you with your order. Can you please provide me with the order ID? This will allow me to look up the specific details of your order.\n&lt;/reply&gt;&quot;
      }
    ],
    &quot;role&quot;: &quot;assistant&quot;
  },
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;my order is 14826&quot;
      }
    ],
    &quot;role&quot;: &quot;user&quot;
  }
]
</code></pre> <p>This <code>messages</code> contains the entire history of the conversation so that Claude has all of the information needed. Because Claude has no "memory" of previous interactions, each time we make a new request, we need to tell it everything that has happened already.</p> <p>Because Claude knows that it has tools available to it (as defined in the <code>toolConfig</code>) and it has the required information (the order ID), the response from Bedrock will have a <code>stopReason</code> of <code>tool_use</code> and the information needed to use the tool.</p> <pre><code class=language-json>{
  &quot;output&quot;: {
    &quot;message&quot;: {
      &quot;role&quot;: &quot;assistant&quot;,
      &quot;content&quot;: [
        {
          &quot;text&quot;: &quot;Okay, got it. &lt;thinking&gt;\nThe user provided the order ID 14826. I can use the \&quot;get_order_by_id\&quot; tool to retrieve the details for this order:&quot;
        },
        {
          &quot;toolUse&quot;: {
            &quot;toolUseId&quot;: &quot;tooluse_D37XtLaVTOCceSv_GMn1wA&quot;,
            &quot;name&quot;: &quot;get_order_by_id&quot;,
            &quot;input&quot;: {
              &quot;order_id&quot;: &quot;14826&quot;
            }
          }
        }
      ]
    }
  },
  &quot;stopReason&quot;: &quot;tool_use&quot;
}
</code></pre> <h3 id=using-the-tool>Using the tool</h3> <p>Now our code knows that Claude wants to use a tool. But Claude cannot use the tool itself. This is where we need to step in and process the request for Claude. This changes the flow to include a direct request to our database.</p> <p><a class=glightbox href=images/ToolUseFlow.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=ToolUseFlow src=images/ToolUseFlow.png></a></p> <p>We continue to update the conversation Table with each turn, but because these steps do not need to be exposed to the user, we do not need to include updates to the subscription.</p> <p>We will make an SQL request to our database using the <code>order_id</code> provided to us by Claude. Because Claude knows the input schema of our tool, it is able to provide a response in the desired shape. This was defined <a href=src/resources/resolverLambda/tools.py>here</a> as part of the <code>toolConfig</code> passed to Claude:</p> <pre><code class=language-json>        &quot;inputSchema&quot;: {
            &quot;json&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;properties&quot;: {
                    &quot;order_id&quot;: {
                        &quot;type&quot;: &quot;string&quot;,
                        &quot;description&quot;: &quot;The unique identifier for the order.&quot;,
                    }
                },
                &quot;required&quot;: [&quot;order_id&quot;],
            },
        },
</code></pre> <p>That allows us to extract the information from the response:</p> <pre><code class=language-json>{
  &quot;toolUse&quot;: {
    &quot;toolUseId&quot;: &quot;tooluse_D37XtLaVTOCceSv_GMn1wA&quot;,
    &quot;name&quot;: &quot;get_order_by_id&quot;,
    &quot;input&quot;: {
      &quot;order_id&quot;: &quot;14826&quot;
    }
  }
}
</code></pre> <p>Now, when we call our <a href=src/resources/resolverLambda/message_processing.py><code>process_tool_call</code></a> function, we are able to determine what the SQL should look like based on the <code>tool_name</code> that Claude wants to use and return the results.</p> <pre><code class=language-python>            elif tool_name == &quot;get_order_by_id&quot;:
                order_id = tool_input[&quot;order_id&quot;]
                query = &quot;SELECT * FROM orders WHERE id = %s&quot;
                logging.info(
                    f&quot;Executing query: {query} with order_id: {order_id}&quot;
                )
                cursor.execute(query, (order_id,))
                order = cursor.fetchone()
                if order:
                    order_dict = dict(
                        zip(
                            [
                                &quot;id&quot;,
                                &quot;customer_id&quot;,
                                &quot;product&quot;,
                                &quot;quantity&quot;,
                                &quot;price&quot;,
                                &quot;status&quot;,
                            ],
                            order,
                        )
                    )
                    logging.info(f&quot;Order found: {order_dict}&quot;)  # Log the found order
                    return order_dict
                else:
                    logging.info(f&quot;Order not found with ID: {order_id}&quot;)
                    return None
</code></pre> <pre><code class=language-SQL>SELECT * FROM orders WHERE id = %s with order_id: 14826
</code></pre> <p>After we get the response from our database, we will append that message as a <code>user</code> turn and send it back to Bedrock.</p> <pre><code class=language-json>[
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;i need help with an order&quot;
      }
    ],
    &quot;role&quot;: &quot;user&quot;
  },
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;Okay, let's see how I can assist you with your order. &lt;thinking&gt;\nTo look up details about an order, I will need the order ID. I should ask the user for that first.\n&lt;/thinking&gt;\n\n&lt;reply&gt;\nSure, I'd be happy to help you with your order. Can you please provide me with the order ID? This will allow me to look up the specific details of your order.\n&lt;/reply&gt;&quot;
      }
    ],
    &quot;role&quot;: &quot;assistant&quot;
  },
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;my order is 14826&quot;
      }
    ],
    &quot;role&quot;: &quot;user&quot;
  },
  {
    &quot;role&quot;: &quot;assistant&quot;,
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;Okay, got it. &lt;thinking&gt;\nThe user provided the order ID 14826. I can use the \&quot;get_order_by_id\&quot; tool to retrieve the details for this order:&quot;
      },
      {
        &quot;toolUse&quot;: {
          &quot;toolUseId&quot;: &quot;tooluse_D37XtLaVTOCceSv_GMn1wA&quot;,
          &quot;name&quot;: &quot;get_order_by_id&quot;,
          &quot;input&quot;: &quot;{\&quot;order_id\&quot;: \&quot;14826\&quot;}&quot;
        }
      }
    ]
  },
  {
    &quot;role&quot;: &quot;user&quot;,
    &quot;content&quot;: [
      {
        &quot;toolResult&quot;: {
          &quot;toolUseId&quot;: &quot;tooluse_D37XtLaVTOCceSv_GMn1wA&quot;,
          &quot;content&quot;: [
            {
              &quot;text&quot;: &quot;{\&quot;id\&quot;: \&quot;14826\&quot;, \&quot;customer_id\&quot;: \&quot;678902\&quot;, \&quot;product\&quot;: \&quot;Backpack\&quot;, \&quot;quantity\&quot;: 1, \&quot;price\&quot;: 59.99, \&quot;status\&quot;: \&quot;Shipped\&quot;}&quot;
            }
          ],
          &quot;status&quot;: &quot;success&quot;
        }
      }
    ]
  }
]
</code></pre> <p>Now Claude has the result of the tool that it wanted to use, we will get back a new response.</p> <pre><code class=language-json>{
  &quot;output&quot;: {
    &quot;message&quot;: {
      &quot;role&quot;: &quot;assistant&quot;,
      &quot;content&quot;: [
        {
          &quot;text&quot;: &quot;The tool returned the order details - it's for 1 Backpack that has already shipped, with a total price of $59.99. I can provide this information to the user.\n&lt;/thinking&gt;\n\n&lt;reply&gt;\nI was able to look up your order #14826. It was for 1 Backpack at $59.99. The order status shows that it has been shipped already. Please let me know if you need any other details about this order.\n&lt;/reply&gt;&quot;
        }
      ]
    }
  },
  &quot;stopReason&quot;: &quot;end_turn&quot;
}
</code></pre> <p>After we've used the tool, and Claude doesn't need to use it again, we get a <code>stopReason</code> of <code>end_turn</code> and can return this response back to the user.</p> <p>The process to do this in the Lambda resolver looks something like this:</p> <pre><code class=language-python>    bot_response, stop_reason = process_message(messages)
    updated_conversation = update_conversation(conversation_id, owner_id, bot_response)
    while stop_reason == &quot;tool_use&quot;:
        messages.append(bot_response)
        tool_response = use_tool(messages)
        messages.append(tool_response)
        update_conversation(conversation_id, owner_id, tool_response)
        bot_response, stop_reason = process_message(messages)
        update_conversation(conversation_id, owner_id, bot_response)
</code></pre> <p>While Claude wants to use a tool, we will continue to loop through this process.</p> <p><a class=glightbox href=images/ToolUseChat.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=ToolUseChat src=images/ToolUseChat.png></a></p> <h3 id=continued-conversation>Continued conversation</h3> <p>We can continue this conversation with additional requests.</p> <pre><code class=language-text>User: I'd like to cancel this order
</code></pre> <pre><code class=language-json>[
  {
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;I'd like to cancel this order&quot;
      }
    ],
    &quot;role&quot;: &quot;user&quot;
  },
  {
    &quot;role&quot;: &quot;assistant&quot;,
    &quot;content&quot;: [
      {
        &quot;text&quot;: &quot;Okay, got it. &lt;thinking&gt;\nThe user wants to cancel order #14826 for the Backpack. To cancel an order, I need to use the \&quot;cancel_order\&quot; tool and provide the order_id.\n\nFirst, let me double check the status of the order:&quot;
      },
      {
        &quot;toolUse&quot;: {
          &quot;toolUseId&quot;: &quot;tooluse_TGy4SjAgTve9nH4u5ePRbg&quot;,
          &quot;name&quot;: &quot;get_order_by_id&quot;,
          &quot;input&quot;: &quot;{\&quot;order_id\&quot;: \&quot;14826\&quot;}&quot;
        }
      }
    ]
  }
]
</code></pre> <p>Claude has recognized that the user wants to cancel the order and knows that it needs the order ID in order to do this. But because we are including the entire conversation history with each request, it already has the order ID and doesn't need to get that information from the user again. But it does want to double check the order status as it may have changed.</p> <p>When we pass this back to Bedrock, we get a response similar to this:</p> <pre><code class=language-json>{
  &quot;output&quot;: {
    &quot;message&quot;: {
      &quot;role&quot;: &quot;assistant&quot;,
      &quot;content&quot;: [
        {
          &quot;text&quot;: &quot;The status shows \&quot;Shipped\&quot;, which means the order has already been fulfilled and shipped out.\n\nThe \&quot;cancel_order\&quot; tool states that only orders with a \&quot;processing\&quot; status can be cancelled. Since this order has already shipped, I cannot cancel it using the tool.\n&lt;/thinking&gt;\n\n&lt;reply&gt;\nUnfortunately, I am unable to cancel your order #14826 for the Backpack at this time. The order status shows that it has already been shipped. Orders can only be cancelled if they are still in the \&quot;processing\&quot; stage before being shipped out.\n\nSince your order has already shipped, it cannot be cancelled through our system. Please let me know if you need any other assistance regarding this order.\n&lt;/reply&gt;&quot;
        }
      ]
    }
  },
  &quot;stopReason&quot;: &quot;end_turn&quot;
}
</code></pre> <p>Here we can see that even though Claude wants to use the <code>cancel_order</code> tool, that tool definition includes instructions about when it can be used:</p> <pre><code class=language-json>&quot;toolSpec&quot;: {
    &quot;name&quot;: &quot;cancel_order&quot;,
    &quot;description&quot;: &quot;Cancels an order based on a provided order_id.  Only orders that are 'processing' can be cancelled&quot;,
    &quot;inputSchema&quot;: {
        &quot;json&quot;: {
            &quot;type&quot;: &quot;object&quot;,
            &quot;properties&quot;: {
                &quot;order_id&quot;: {
                    &quot;type&quot;: &quot;string&quot;,
                    &quot;description&quot;: &quot;The order_id pertaining to a particular order&quot;,
                }
            },
            &quot;required&quot;: [&quot;order_id&quot;],
        },
    },
},
</code></pre> <p>Because we have instructed Claude to only allow orders that are in a <code>processing</code> state to be canceled, the <code>stopReason</code> from Bedrock is <code>end_turn</code> instead of <code>tool_use</code> and the response is sent to the user.</p> <p><a class=glightbox href=images/ContinuedUseChat.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=ContinuedUse src=images/ContinuedUseChat.png></a></p> <h2 id=using-the-demo>Using the Demo</h2> <h3 id=deploying>Deploying</h3> <p>To deploy the demo you'll need to meet the following prerequisites:</p> <ul> <li>AWS account</li> <li>AWS CLI <a href=https://docs.aws.amazon.com/cli/v1/userguide/cli-chap-configure.html>configured</a></li> <li>yarn <a href=https://yarnpkg.com/getting-started/install>installed</a></li> <li>Docker <a href=https://docs.docker.com/engine/install/ >installed</a></li> </ul> <p>To deploy the CDK:</p> <pre><code class=language-bash>git clone https://github.com/aws-samples/anthropic-on-aws.git
cd anthropic-on-aws/claude-tools-chatbot
yarn
yarn launch
</code></pre> <h3 id=logging-in>Logging In</h3> <p>Once deployed, your demo will include output with an <a href=https://aws.amazon.com/cloudfront/ >Amazon CloudFront</a> distribution URL. You can use this to log in to the client by creating an Amazon Cognito user with a valid email address.</p> <p><a class=glightbox href=images/SignUp.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=SignUp src=images/SignUp.png></a></p> <p>Once you have received the validation code from Cognito, you can log in and try out some questions. The data loaded in to the database can be found <a href=src/resources/initializerLambda/data.py>here</a></p> <h3 id=example-conversations>Example Conversations</h3> <h4 id=order-lookup>Order Lookup</h4> <pre><code class=language-text>I need help with an order
</code></pre> <pre><code class=language-text>My order is 32057
</code></pre> <h4 id=cancel-order>Cancel Order</h4> <pre><code class=language-text>I need help with an order
</code></pre> <pre><code class=language-text>My order is 37129
</code></pre> <pre><code class=language-text>Please cancel my order
</code></pre> <h4 id=account-lookup>Account Lookup</h4> <pre><code class=language-text>Hello, I need some help
</code></pre> <pre><code class=language-text>I don't remember my order id
</code></pre> <pre><code class=language-text>My email is anacarolina_silva@example.com
</code></pre> <pre><code class=language-text>What are my orders
</code></pre> <h4 id=combining-requests>Combining Requests</h4> <pre><code class=language-text>I need to cancel an order but don't remember my order id
</code></pre> <pre><code class=language-text>My phone number is 312-555-8204
</code></pre> <pre><code>Yes
</code></pre> <h3 id=cleanup>Cleanup</h3> <p>To remove the resources created:</p> <pre><code>yarn cdk destroy
</code></pre> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["header.autohide", "navigation.instant", "navigation.sections", "navigation.top", "navigation.indexes", "search.highlight", "search.share", "search.suggest", "content.code.annotate", "content.tooltips", "content.tabs.link", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.f1b6f286.min.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>